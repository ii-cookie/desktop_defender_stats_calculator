<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop Defender: Stats Calculator (WIP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1f2937; }
        #loot-popup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10; }
        #loot-popup-content { max-height:80vh; overflow-y:auto; }
        #loot-popup-content::-webkit-scrollbar { display:none; }
        #loot-popup-content { -ms-overflow-style:none; scrollbar-width:none; }

        /* ---- LOOT SLOT ---- */
        .loot-slot {
            position: relative;
            width: 100%;               /* fill the grid cell */
            padding-bottom: 100%;      /* 1:1 ratio → perfect square */
            background: #1f2937;
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .loot-slot .inner {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loot-slot img {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;      /* keep original shape */
        }
        .loot-slot .plus {
            font-size: 2.5rem;
            color: #9ca3af;
        }

        /* ---- REMOVE BUTTON ---- */
        .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(220,53,69,0.9);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            font-size: 13px;
            line-height: 1;
            cursor: pointer;
            opacity: 0;
            transition: opacity .2s;
            z-index: 2;
        }
        .loot-slot:hover .remove-btn { opacity:1; }
        .remove-btn:hover { background:#dc2626; }
    </style>
</head>
<body class="font-sans text-gray-100">
<div class="container mx-auto p-4 max-w-4xl">
    <h1 class="text-3xl font-bold text-center mb-6 text-white">Desktop Defender: Stats Calculator (WIP)</h1>

    <!-- Weapons -->
    <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">Select Weapon</h2>
        <div id="weapons-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
    </section>

    <!-- Loot Grid (3×6) -->
    <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">Select Loot</h2>
        <div id="loot-grid" class="grid grid-cols-6 gap-2 w-full max-w-md mx-auto"></div>
    </section>

    <!-- Loot Popup -->
    <div id="loot-popup">
        <div id="loot-popup-content"
             class="bg-gray-800 p-4 rounded-lg shadow-lg mx-auto mt-20 max-w-4xl w-full grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2">
        </div>
    </div>

    <!-- Input Levels -->
    <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">Input Levels</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-300">Level</label><input type="number" id="level" value="30" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div><label class="block text-sm font-medium text-gray-300">Damage Level</label><input type="number" id="damage_level" value="100" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div><label class="block text-sm font-medium text-gray-300">Flat Level</label><input type="number" id="flat_level" value="50" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div><label class="block text-sm font-medium text-gray-300">Extra Projectile Level</label><input type="number" id="extra_projectile_level" value="3" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div><label class="block text-sm font-medium text-gray-300">Firerate Level</label><input type="number" id="firerate_level" value="100" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
        </div>
    </section>

    <!-- Calculate -->
    <div class="text-center mb-8">
        <button id="calculate-btn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Calculate</button>
    </div>

    <!-- Results -->
    <section id="results" class="hidden">
        <h2 class="text-2xl font-semibold mb-4 text-white">Results</h2>
        <div class="bg-gray-800 p-4 rounded shadow-md">
            <p class="text-gray-100"><strong>Damage:</strong> <span id="result-damage">0</span></p>
            <p class="text-gray-100"><strong>Projectiles per Shot:</strong> <span id="result-projectiles">0</span></p>
            <p class="text-gray-100"><strong>Firerate:</strong> <span id="result-firerate">0</span></p>
            <p class="text-gray-100"><strong>Total Damage per Shot:</strong> <span id="result-total-damage">0</span></p>
            <p class="text-gray-100"><strong>Damage per Second:</strong> <span id="result-dps">0</span></p>
        </div>
    </section>

    <footer class="text-left py-4 text-gray-400">
        Created by <a href="https://github.com/ii-cookie" class="text-blue-500 hover:underline">iicookie</a> |
        Equations by <a href="https://github.com/asdfgasdfs" class="text-blue-500 hover:underline">aguy5235</a> |
        Assets from the <a href="https://desktopdefender.miraheze.org/wiki/Main_Page" class="text-blue-500 hover:underline">wiki</a>
    </footer>
</div>

<script>
    let data = null;
    const lootSlots = Array(18).fill(null);
    const lootGrid = document.getElementById('loot-grid');
    const lootPopup = document.getElementById('loot-popup');
    const lootPopupContent = document.getElementById('loot-popup-content');

    /* ---------- DATA LOADING ---------- */
    async function loadData() {
        try {
            const [w, l] = await Promise.all([fetch('weapons.json'), fetch('loot.json')]);
            const weapons = await w.json();
            const loot = await l.json();
            data = { weapons: weapons.weapons, loot: loot.loot };
            initApp();
        } catch (e) { console.error(e); alert('Failed to load JSON files'); }
    }

    /* ---------- CALCULATION FUNCTIONS ---------- */
    function damage_percent(l) { return 0.0000103078*l**3 - 0.00309212*l**2 + 0.309199*l - 0.306333; }
    function flat_damage(l)   { return (50/49)*l - 50/49; }
    function damage_mult(l)   { return l<4?1:l<10?1.2:l<21?1.44:1.728; }
    function damage(l,wd,wa,dl,fl,lp,ld) {
        return (wd + (flat_damage(fl)+ld)*wa) * damage_mult(l) * (1 + damage_percent(dl) + lp);
    }
    function firerate_upgrade(l) { const x = Math.max(0, Math.min(400, l));
        return 0.75 * (1 - Math.pow((400 - x) / 400, 3)); }
    function firerate(wfr,frl,lfr,wn) {
        const calc = (1/wfr)*(1-(firerate_upgrade(frl)+lfr));
        const min  = wn?.toLowerCase()==='flamethrower'?1/60:0.1;
        return {display:calc, capped:Math.max(calc,min)};
    }
    function projectiles_per_shot(epl,lp) { return 1 + Math.ceil((epl-1)*1.5) + lp; }
    function total_damage_per_shot(...args) { return damage(...args)*projectiles_per_shot(args[6],args[7]); }
    function damage_per_second(td,fr) { return td/fr; }
    function get_weapon_damage(w)      { return w?.stats?.Damage||0; }
    function get_weapon_added_mult(w)  { return w?.name?.toLowerCase()==='flamethrower'?0.1:w?.stats?.['Added Damage Mult']||1; }
    function get_loot_percentage(a)   { return a.reduce((s,i)=>s+(i?.stats?.['Projectile Damage']||0),0); }
    function get_loot_damage(a)       { return a.reduce((s,i)=>s+(i?.stats?.['Shot Damage']||0),0); }
    function get_loot_projectile(a)   { return a.reduce((s,i)=>s+(i?.stats?.['Projectile Shot']||0),0); }
    function get_weapon_fire_rate(w)  { return w?.stats?.['Fire Rate']||0; }
    function get_loot_fire_rate(a)    { return a.reduce((s,i)=>s+(i?.stats?.['Fire Rate']||0),0); }

    /* ---------- SLOT RENDERING ---------- */
    function renderSlot(idx) {
        const slot = document.createElement('div');
        slot.className = 'loot-slot';
        slot.dataset.idx = idx;

        if (lootSlots[idx]) {
            const l = lootSlots[idx];
            slot.innerHTML = `
                <div class="inner">
                    <img src="${l.icon}" alt="${l.name}">
                    <button class="remove-btn" title="Remove">X</button>
                </div>`;
            slot.querySelector('.remove-btn').onclick = e => {
                e.stopPropagation();
                clearSlot(idx);
            };
        } else {
            slot.innerHTML = `<div class="inner"><span class="plus">+</span></div>`;
        }

        slot.onclick = () => openPopup(idx);
        return slot;
    }

    function clearSlot(idx) {
        lootSlots[idx] = null;
        saveSlots();
        lootGrid.children[idx].replaceWith(renderSlot(idx));
    }

    function setSlot(idx, loot) {
        lootSlots[idx] = loot;
        saveSlots();
        lootGrid.children[idx].replaceWith(renderSlot(idx));
    }

    function saveSlots() {
        localStorage.setItem('lootSlots', JSON.stringify(lootSlots.map(l=>l?.name||null)));
    }

    function openPopup(idx) {
        lootPopup.style.display = 'flex';
        lootPopupContent.dataset.idx = idx;
    }

    /* ---------- POPUP ---------- */
    lootPopup.onclick = e => { if (e.target===lootPopup) lootPopup.style.display='none'; };

    /* ---------- INITIALISATION ---------- */
    function initApp() {
        /* weapons */
        data.weapons.forEach(w => {
            const b = document.createElement('button');
            b.textContent = w.name;
            b.className = 'p-2 border rounded bg-gray-600 hover:bg-gray-500 text-gray-100 border-gray-500';
            b.onclick = () => {
                document.querySelectorAll('#weapons-container button')
                    .forEach(x=>x.className='p-2 border rounded bg-gray-600 hover:bg-gray-500 text-gray-100 border-gray-500');
                b.className='p-2 border rounded bg-blue-600 text-white border-blue-500';
                selectedWeapon = w;
                localStorage.setItem('selectedWeapon', w.name);
            };
            document.getElementById('weapons-container').appendChild(b);
        });

        /* 18 loot slots */
        for (let i=0;i<18;i++) lootGrid.appendChild(renderSlot(i));

        /* loot cards */
        const rarityColor = {C:'text-blue-300',B:'text-orange-500',D:'text-green-500',E:'text-blue-600'};
        Object.values(data.loot).flat().forEach(l => {
            const r = Object.keys(data.loot).find(k=>data.loot[k].some(x=>x.name===l.name));
            const card = document.createElement('div');
            card.className='bg-gray-800 p-2 rounded shadow-md flex flex-col items-center text-sm cursor-pointer hover:bg-gray-700';
            card.innerHTML = `
                <img src="${l.icon}" class="w-10 h-10 mb-1 object-contain">
                <span class="text-xs text-gray-100">${l.name}</span>
                <span class="text-xs ${rarityColor[r]||'text-gray-400'}">Rarity: ${r}</span>`;
            card.onclick = () => {
                const idx = +lootPopupContent.dataset.idx;
                setSlot(idx, l);
                lootPopup.style.display='none';
            };
            lootPopupContent.appendChild(card);
        });

        /* load saved data */
        const savedWeapon = localStorage.getItem('selectedWeapon');
        if (savedWeapon) document.querySelector(`#weapons-container button`)?.click();

        JSON.parse(localStorage.getItem('lootSlots')||'[]').forEach((n,i) => {
            if (n && i<18) {
                const l = Object.values(data.loot).flat().find(x=>x.name===n);
                if (l) setSlot(i,l);
            }
        });

        ['level','damage_level','flat_level','extra_projectile_level','firerate_level'].forEach(id => {
            const v = localStorage.getItem(id);
            if (v!==null) document.getElementById(id).value = v;
            document.getElementById(id).oninput = () => localStorage.setItem(id, document.getElementById(id).value);
        });
    }

    /* ---------- CALCULATE ---------- */
    let selectedWeapon = null;
    document.getElementById('calculate-btn').onclick = () => {
        if (!selectedWeapon) return alert('Select a weapon first');

        const loots = lootSlots.filter(Boolean);
        const lvl = +document.getElementById('level').value || 1;
        const dmgLvl = +document.getElementById('damage_level').value || 1;
        const flatLvl = +document.getElementById('flat_level').value || 1;
        const projLvl = +document.getElementById('extra_projectile_level').value || 1;
        const frLvl = +document.getElementById('firerate_level').value || 1;

        const wd = get_weapon_damage(selectedWeapon);
        const wa = get_weapon_added_mult(selectedWeapon);
        const lp = get_loot_percentage(loots);
        const ld = get_loot_damage(loots);
        const lproj = get_loot_projectile(loots);
        const wfr = get_weapon_fire_rate(selectedWeapon);
        const lfr = get_loot_fire_rate(loots);

        const dmg = damage(lvl,wd,wa,dmgLvl,flatLvl,lp,ld);
        const proj = projectiles_per_shot(projLvl,lproj);
        const fr = firerate(wfr,frLvl,lfr,selectedWeapon.name);
        const tot = total_damage_per_shot(lvl,wd,wa,dmgLvl,flatLvl,lp,ld,projLvl,lproj);
        const dps = damage_per_second(tot,fr.capped);

        document.getElementById('result-damage').textContent = dmg.toFixed(6);
        document.getElementById('result-projectiles').textContent = Math.floor(proj);
        document.getElementById('result-firerate').textContent =
            fr.display < (selectedWeapon.name.toLowerCase()==='flamethrower'?1/60:0.1)
            ? `${fr.display.toFixed(6)} (min firerate reached)`
            : fr.display.toFixed(6);
        document.getElementById('result-total-damage').textContent = tot.toFixed(6);
        document.getElementById('result-dps').textContent = dps.toFixed(6);
        document.getElementById('results').classList.remove('hidden');
    };

    loadData();
</script>
</body>
</html>