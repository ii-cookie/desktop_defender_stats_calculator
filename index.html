<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop Defender: Stats Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #1f2937; /* Dark gray background */
        }
        /* Popup overlay */
        #loot-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }
        /* Popup content */
        #loot-popup-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        /* Hide scrollbar but keep functionality */
        #loot-popup-content::-webkit-scrollbar {
            display: none;
        }
        #loot-popup-content {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Ensure slot images cover the entire slot */
        .slot-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body class="font-sans text-gray-100">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-white">Desktop Defender: Stats Calculator</h1>

        <!-- Weapons Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white">Select Weapon</h2>
            <div id="weapons-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
        </section>

        <!-- Loot Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white">Select Loot</h2>
            <div id="loot-grid" class="grid grid-cols-3 gap-2 w-64 mx-auto">
                <!-- 9 slots will be dynamically generated -->
            </div>
        </section>

        <!-- Loot Popup -->
        <div id="loot-popup">
            <div id="loot-popup-content" class="bg-gray-800 p-4 rounded-lg shadow-lg mx-auto mt-20 max-w-lg w-full grid grid-cols-2 sm:grid-cols-3 gap-2">
                <!-- Loot cards will be dynamically generated -->
            </div>
        </div>

        <!-- Input Levels Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white">Input Levels</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300">Level</label>
                    <input type="number" id="level" value="30" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Damage Level</label>
                    <input type="number" id="damage_level" value="100" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Flat Level</label>
                    <input type="number" id="flat_level" value="50" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Extra Projectile Level</label>
                    <input type="number" id="extra_projectile_level" value="3" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Firerate Level</label>
                    <input type="number" id="firerate_level" value="100" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </section>

        <!-- Calculate Button -->
        <div class="text-center mb-8">
            <button id="calculate-btn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Calculate</button>
        </div>

        <!-- Results Section -->
        <section id="results" class="hidden">
            <h2 class="text-2xl font-semibold mb-4 text-white">Results</h2>
            <div class="bg-gray-800 p-4 rounded shadow-md">
                <p class="text-gray-100"><strong>Damage:</strong> <span id="result-damage">0</span></p>
                <p class="text-gray-100"><strong>Projectiles per Shot:</strong> <span id="result-projectiles">0</span></p>
                <p class="text-gray-100"><strong>Firerate:</strong> <span id="result-firerate">0</span></p>
                <p class="text-gray-100"><strong>Total Damage per Shot:</strong> <span id="result-total-damage">0</span></p>
                <p class="text-gray-100"><strong>Damage per Second:</strong> <span id="result-dps">0</span></p>
            </div>
        </section>
    <footer class="text-left py-4 text-gray-400">
        Created and maintained by <a href="https://github.com/ii-cookie" class="text-blue-500 hover:underline">iicookie</a> <br>
        Equation provided by <a href="https://github.com/asdfgasdfs" class="text-blue-500 hover:underline">aguy5235</a> <br>
        Assets provided by the <a href="https://desktopdefender.miraheze.org/wiki/Main_Page" class="text-blue-500 hover:underline">wiki</a> <br>
        and all the contributions from the <a href="https://discord.gg/eG3BQRYJ6m" class="text-blue-500 hover:underline">discord community</a>
    </footer>
    </div>

    <script>
        /* -------------------------------------------------------------
           1. Load the two JSON files and build the same `data` object
           ------------------------------------------------------------- */
        let data = null;                     // will hold { weapons:…, loot:… }
        const LOOT_URL    = 'loot.json';
        const WEAPONS_URL = 'weapons.json';
        
        async function loadData() {
            try {
                const [lootRes, weaponsRes] = await Promise.all([
                    fetch(LOOT_URL).then(r => r.json()),
                    fetch(WEAPONS_URL).then(r => r.json())
                ]);
        
                // loot.json already has the shape { loot: { B:…, C:…, … } }
                // weapons.json has an array at the root
                data = {
                    loot:    lootRes.loot,          // keep the nested B/C/D/E groups
                    weapons: weaponsRes.weapons     // array of weapon objects
                };
        
                // -------------------------------------------------
                // 2. Everything that used `data` before can stay!
                // -------------------------------------------------
                initApp();
            } catch (err) {
                console.error('Could not load JSON files:', err);
                alert('Failed to load game data – check the console.');
            }
        }
        
        /* -------------------------------------------------------------
           2. The whole original script – unchanged except it now
               runs **after** `data` is ready (inside initApp())
           ------------------------------------------------------------- */
        function initApp() {
            // ----- original helper functions (damage, firerate, …) -----
            function damage_percent(level) {
                return 0.0000103078 * Math.pow(level, 3) - 0.00309212 * Math.pow(level, 2) + 0.309199 * level - 0.306333;
            }
            function flat_damage(level) {
                return (50 / 49) * level - 50 / 49;
            }
            function damage_mult(level) {
                if (level < 4) return 1;
                else if (level < 10) return 1.2;
                else if (level < 21) return 1.2 ** 2;
                else return 1.2 ** 3;
            }
            function damage(level, weapon_damage, weapon_added_mult, damage_level, flat_level, loot_percentage, loot_damage) {
                return (weapon_damage * (1 + damage_percent(damage_level) + loot_percentage) +
                        (flat_damage(flat_level) + loot_damage) * weapon_added_mult) * damage_mult(level);
            }
            function firerate_upgrade(level) {
                return (7.73341e-7) * Math.pow(level, 3) - 0.000231949 * Math.pow(level, 2) + 0.0231915 * level - 0.0229862;
            }
            function firerate(weapon_firerate, firerate_level, loot_firerate, weapon_name) {
                const calculatedFirerate = (1 / weapon_firerate) * (1 - (firerate_upgrade(firerate_level) + loot_firerate));
                const minFirerate = weapon_name?.toLowerCase() === 'flamethrower' ? 1 / 60 : 0.1;
                const cappedFirerate = Math.max(calculatedFirerate, minFirerate);
                return { display: calculatedFirerate, capped: cappedFirerate };
            }
            function projectiles_per_shot(extra_projectile_level, loot_projectile) {
                return 1 + Math.ceil((extra_projectile_level - 1) * 1.5) + loot_projectile;
            }
            function total_damage_per_shot(level, weapon_damage, weapon_added_mult, damage_level, flat_level, loot_percentage, loot_damage, extra_projectile_level, loot_projectile) {
                return damage(level, weapon_damage, weapon_added_mult, damage_level, flat_level, loot_percentage, loot_damage) *
                       projectiles_per_shot(extra_projectile_level, loot_projectile);
            }
            function damage_per_second(total_damage, firerate) {
                return total_damage / firerate;
            }
        
            // ----- getters -----
            function get_weapon_damage(weapon)          { return weapon?.stats?.Damage || 0; }
            function get_weapon_added_mult(weapon) {
                if (weapon?.name?.toLowerCase() === 'flamethrower') return 0.1;
                return weapon?.stats?.['Added Damage Mult'] || 1;
            }
            function get_loot_percentage(loots)        { return loots.reduce((s,l)=>s+(l?.stats?.['Projectile Damage']||0),0); }
            function get_loot_damage(loots)            { return loots.reduce((s,l)=>s+(l?.stats?.['Shot Damage']||0),0); }
            function get_loot_projectile(loots)        { return loots.reduce((s,l)=>s+(l?.stats?.['Projectile Shot']||0),0); }
            function get_weapon_fire_rate(weapon)      { return weapon?.stats?.['Fire Rate'] || 0; }
            function get_loot_fire_rate(loots)         { return loots.reduce((s,l)=>s+(l?.stats?.['Fire Rate']||0),0); }
        
            // ----- UI setup -----
            const weaponsContainer   = document.getElementById('weapons-container');
            const lootGrid           = document.getElementById('loot-grid');
            const lootPopup          = document.getElementById('loot-popup');
            const lootPopupContent   = document.getElementById('loot-popup-content');
            const lootSlots          = Array(9).fill(null);
            let selectedWeapon       = null;
        
            const rarityColors = { B:'text-orange-500', C:'text-blue-300', D:'text-green-500', E:'text-blue-600' };
        
            // ---- weapons buttons ----
            data.weapons.forEach(w => {
                const btn = document.createElement('button');
                btn.textContent = w.name;
                btn.className = 'p-2 border rounded bg-gray-600 hover:bg-gray-500 text-gray-100 border-gray-500';
                btn.onclick = () => {
                    weaponsContainer.querySelectorAll('button')
                        .forEach(b => b.className = 'p-2 border rounded bg-gray-600 hover:bg-gray-500 text-gray-100 border-gray-500');
                    btn.className = 'p-2 border rounded bg-blue-600 text-white border-blue-500';
                    selectedWeapon = w;
                    localStorage.setItem('selectedWeapon', w.name);
                };
                weaponsContainer.appendChild(btn);
            });
        
            // ---- loot grid (9 slots) ----
            for (let i = 0; i < 9; i++) {
                const slot = document.createElement('div');
                slot.className = 'bg-gray-800 p-2 rounded shadow-md flex items-center justify-center h-20 cursor-pointer';
                slot.innerHTML = '<span class="text-2xl text-gray-400">+</span>';
                slot.dataset.slotIndex = i;
                slot.onclick = () => {
                    lootPopup.style.display = 'flex';
                    lootPopupContent.dataset.slotIndex = i;
                };
                lootGrid.appendChild(slot);
            }
        
            // ---- loot popup cards ----
            const allLoots = Object.values(data.loot).flat();
            allLoots.forEach(loot => {
                const rarity = Object.keys(data.loot).find(k => data.loot[k].some(l => l.name === loot.name));
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-2 rounded shadow-md flex flex-col items-center text-sm cursor-pointer hover:bg-gray-700';
                card.innerHTML = `
                    <img src="${loot.icon}" alt="${loot.name}" class="w-10 h-10 mb-1 object-contain">
                    <span class="font-medium text-center text-xs text-gray-100">${loot.name}</span>
                    <span class="text-xs ${rarityColors[rarity]||'text-gray-400'}">Rarity: ${rarity}</span>
                `;
                card.onclick = () => {
                    const idx = +lootPopupContent.dataset.slotIndex;
                    lootSlots[idx] = loot;
                    lootGrid.children[idx].innerHTML = `<img src="${loot.icon}" class="slot-image">`;
                    localStorage.setItem('lootSlots', JSON.stringify(lootSlots.map(l=>l?.name||null)));
                    lootPopup.style.display = 'none';
                };
                lootPopupContent.appendChild(card);
            });
        
            // ---- close popup on outside click ----
            lootPopup.onclick = e => { if (e.target === lootPopup) lootPopup.style.display = 'none'; };
        
            // ---- persist input fields ----
            ['level','damage_level','flat_level','extra_projectile_level','firerate_level'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', () => localStorage.setItem(id, el.value));
            });
        
            // ---- calculate button ----
            document.getElementById('calculate-btn').onclick = () => {
                if (!selectedWeapon) return alert('Pick a weapon first!');
        
                const loots = lootSlots.filter(Boolean);
                const lvl = +document.getElementById('level').value || 1;
                const dmgLvl = +document.getElementById('damage_level').value || 1;
                const flatLvl = +document.getElementById('flat_level').value || 1;
                const projLvl = +document.getElementById('extra_projectile_level').value || 1;
                const frLvl = +document.getElementById('firerate_level').value || 1;
        
                const wDmg   = get_weapon_damage(selectedWeapon);
                const wAdd   = get_weapon_added_mult(selectedWeapon);
                const lPerc  = get_loot_percentage(loots);
                const lDmg   = get_loot_damage(loots);
                const lProj  = get_loot_projectile(loots);
                const wFR    = get_weapon_fire_rate(selectedWeapon);
                const lFR    = get_loot_fire_rate(loots);
        
                const dmg   = damage(lvl, wDmg, wAdd, dmgLvl, flatLvl, lPerc, lDmg);
                const proj  = projectiles_per_shot(projLvl, lProj);
                const fr    = firerate(wFR, frLvl, lFR, selectedWeapon.name);
                const total = total_damage_per_shot(lvl, wDmg, wAdd, dmgLvl, flatLvl, lPerc, lDmg, projLvl, lProj);
                const dps   = damage_per_second(total, fr.capped);
        
                document.getElementById('result-damage').textContent        = dmg.toFixed(6);
                document.getElementById('result-projectiles').textContent   = Math.floor(proj);
                document.getElementById('result-firerate').textContent      = fr.display.toFixed(6);
                document.getElementById('result-total-damage').textContent  = total.toFixed(6);
                document.getElementById('result-dps').textContent           = dps.toFixed(6);
                document.getElementById('results').classList.remove('hidden');
            };
        
            // ---- load saved state (weapon + loot + inputs) ----
            (function loadSaved() {
                const savedW = localStorage.getItem('selectedWeapon');
                if (savedW) {
                    const w = data.weapons.find(x=>x.name===savedW);
                    if (w) {
                        selectedWeapon = w;
                        weaponsContainer.querySelectorAll('button').forEach(b=>{
                            b.className = b.textContent===savedW ?
                                'p-2 border rounded bg-blue-600 text-white border-blue-500' :
                                'p-2 border rounded bg-gray-600 hover:bg-gray-500 text-gray-100 border-gray-500';
                        });
                    }
                }
        
                const savedLoot = JSON.parse(localStorage.getItem('lootSlots')||'[]');
                savedLoot.forEach((name, i) => {
                    if (!name) return;
                    const loot = allLoots.find(l=>l.name===name);
                    if (loot && i<9) {
                        lootSlots[i] = loot;
                        lootGrid.children[i].innerHTML = `<img src="${loot.icon}" class="slot-image">`;
                    }
                });
        
                ['level','damage_level','flat_level','extra_projectile_level','firerate_level'].forEach(id=>{
                    const v = localStorage.getItem(id);
                    if (v) document.getElementById(id).value = v;
                });
            })();
        }
        
        /* -------------------------------------------------------------
           3. Kick everything off
           ------------------------------------------------------------- */
        loadData();
        </script>
</body>
</html>