<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop Defender: Stats Calculator (WIP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1f2937; }
        #loot-popup { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10; }
        #loot-popup-content { max-height:80vh; overflow-y:auto; }
        #loot-popup-content::-webkit-scrollbar { display:none; }
        #loot-popup-content { -ms-overflow-style:none; scrollbar-width:none; }
        /* ---- LOOT STATS TOOLTIP ---- */
        .loot-card { position: relative; }
        .loot-tooltip {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(31,41,55,0.98);
        backdrop-filter: blur(12px);
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #4b5563;
        font-size: 11px;
        color: #e5e7eb;
        white-space: nowrap;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, transform 0.2s;
        pointer-events: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

        /* Default: show on LEFT */
        .loot-tooltip {
            right: 100%;
            transform: translateY(-50%) translateX(-8px);
        }

        /* Flip to RIGHT for first column */
        .loot-card:first-child .loot-tooltip,
        .loot-card:nth-child(5n+1) .loot-tooltip {
            left: 100%;
            right: auto;
            transform: translateY(-50%) translateX(8px);
        }

        /* Hover show */
        .loot-card:hover .loot-tooltip {
            opacity: 1;
            visibility: visible;
        }
        /* ---- LOOT SLOT ---- */
        .loot-slot {
            position: relative;
            width: 100%;               /* fill the grid cell */
            padding-bottom: 100%;      /* 1:1 ratio → perfect square */
            background: #1f2937;
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .loot-slot .inner {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loot-slot img {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;      /* keep original shape */
        }
        .loot-slot .plus {
            font-size: 2.5rem;
            color: #9ca3af;
        }

        /* ---- REMOVE BUTTON ---- */
        .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(220,53,69,0.9);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            font-size: 13px;
            line-height: 1;
            cursor: pointer;
            opacity: 0;
            transition: opacity .2s;
            z-index: 2;
        }
        .loot-slot:hover .remove-btn { opacity:1; }
        .remove-btn:hover { background:#dc2626; }
    </style>
</head>
<body class="font-sans text-gray-100">
<div class="container mx-auto p-4 max-w-4xl">
    <h1 class="text-3xl font-bold text-center mb-6 text-white">Desktop Defender: Stats Calculator (WIP)</h1>

    <!-- Weapons -->
    <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">Select Weapon</h2>
        <div id="weapons-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
    </section>

    <!-- Loot Grid (3×6) -->
    <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">Select Loot</h2>
        <div id="loot-grid" class="grid grid-cols-6 gap-2 w-full max-w-md mx-auto"></div>
    </section>

    <!-- Loot Popup -->
    <div id="loot-popup" class="fixed inset-0 bg-black/70 flex items-start justify-center z-50 overflow-y-auto">
        <div class="bg-gray-800 rounded-lg shadow-2xl max-w-5xl w-full mx-4 my-8 flex flex-col max-h-screen">
            
            <!-- Fixed Search Bar (always on top) -->
            <div class="p-4 border-b border-gray-700 sticky top-0 bg-gray-800 z-10">
                <input type="text" id="loot-search" placeholder="Search loot..."
                       class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 
                              focus:outline-none focus:ring-2 focus:ring-blue-500 text-base">
            </div>
    
            <!-- Scrollable Loot Grid -->
            <div id="loot-popup-content" 
                 class="p-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 overflow-y-auto flex-1">
                <!-- loot cards will go here -->
            </div>
        </div>
    </div>

    <!-- Input Levels -->
    <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">Input Levels</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-300">Level</label><input type="number" id="level" value="30" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div><label class="block text-sm font-medium text-gray-300">Damage Level</label><input type="number" id="damage_level" value="100" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div><label class="block text-sm font-medium text-gray-300">Flat Level</label><input type="number" id="flat_level" value="50" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div><label class="block text-sm font-medium text-gray-300">Extra Projectile Level</label><input type="number" id="extra_projectile_level" value="3" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div><label class="block text-sm font-medium text-gray-300">Firerate Level</label><input type="number" id="firerate_level" value="100" min="1" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
        </div>
    </section>

    <!-- Calculate -->
    <div class="text-center mb-8">
        <button id="calculate-btn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Calculate</button>
    </div>

    <!-- Results -->
    <section id="results" class="hidden">
        <h2 class="text-2xl font-semibold mb-4 text-white">Results</h2>
        <div class="bg-gray-800 p-4 rounded shadow-md">
            <p class="text-gray-100"><strong>Damage:</strong> <span id="result-damage">0</span></p>
            <p class="text-gray-100"><strong>Projectiles per Shot:</strong> <span id="result-projectiles">0</span></p>
            <p class="text-gray-100"><strong>Firerate:</strong> <span id="result-firerate">0</span></p>
            <p class="text-gray-100"><strong>Total Damage per Shot:</strong> <span id="result-total-damage">0</span></p>
            <p class="text-gray-100"><strong>Damage per Second:</strong> <span id="result-dps">0</span></p>
    
            <!-- NEW: Collapsible Details -->
            <details class="mt-4 text-sm text-gray-400 cursor-pointer">
                <summary class="inline-flex items-center gap-1 hover:text-gray-200">
                    details <span class="inline-block text-xs">▼</span>
                </summary>
                <div id="calc-details" class="mt-2 pl-4 space-y-1 text-gray-300"></div>
            </details>
        </div>
    </section>

    <footer class="text-left py-4 text-gray-400">
        Created by <a href="https://github.com/ii-cookie" class="text-blue-500 hover:underline">iicookie</a> |
        Equations by <a href="https://github.com/asdfgasdfs" class="text-blue-500 hover:underline">aguy5235</a> |
        Assets from the <a href="https://desktopdefender.miraheze.org/wiki/Main_Page" class="text-blue-500 hover:underline">wiki</a>
    </footer>
</div>

<script>
    let data = null;
    const lootSlots = Array(18).fill(null);
    const lootGrid = document.getElementById('loot-grid');
    const lootPopup = document.getElementById('loot-popup');
    const lootPopupContent = document.getElementById('loot-popup-content');

    /* ---------- DATA LOADING ---------- */
    async function loadData() {
        try {
            const [weaponsResponse, lootResponse] = await Promise.all([fetch('weapons.json'), fetch('loot_update.json')]);
            const weapons = await weaponsResponse.json();
            const loot = await lootResponse.json();
            data = { weapons: weapons.weapons, loot: loot.loot };
            initApp();
        } catch (error) { console.error(error); alert('Failed to load JSON files'); }
    }

    /* ---------- CALCULATION FUNCTIONS ---------- */
    // PlayerUpgrades.StatData → JavaScript (infinite repeat)
    function evaluateValue(level, startValue, endValue, maxLevel, infiniteRepeat) {
    // -----------------------------------------------------------------
    // 1. NON-INFINITE (unchanged)
    // -----------------------------------------------------------------
    const curve = (x) => (endValue - startValue) *
        (1 - Math.pow((maxLevel - x) / maxLevel, 3)) + startValue;

    if (!infiniteRepeat) {
        level = Math.max(1, Math.min(level, maxLevel));
        if (level === 1) return startValue;
        if (level === maxLevel) return endValue;

        const t = (level - 1) / (maxLevel - 1);
        return curve(t);
    }

    // -----------------------------------------------------------------
    // 2. INFINITE REPEAT – NEW IMPLEMENTATION
    // -----------------------------------------------------------------
    if (maxLevel <= 1) {
        // every level adds the full delta
        const delta = endValue - startValue;
        return startValue + Math.max(0, level - 1) * delta;
    }

    const MaxEffect   = endValue - startValue;          // Δ
    const cycleLen    = maxLevel - 1;                   // e.g. 199
    const fullCycles  = Math.floor((level - 1) / cycleLen);
    const remainder   = (level - 1) % cycleLen;         // 0 … cycleLen-1

    // progress inside the current cycle: 0 → 0, cycleLen-1 → 1
    const p = remainder / cycleLen;                     // 0 … 1 (almost)

    // 1 - (1-p)^3  → smooth cubic rise from 0 to 1
    const cubic = 1 - Math.pow(1 - p, 3);

    // f_inf(x) = MaxEffect * (cubic + fullCycles)
    const value = MaxEffect * (cubic + fullCycles) + startValue;

    return value;
}
    function damage_percent(level) { 
        const startValue = 0;
        const endValue   = 20;
        const maxLevel   = 200;
        const infiniteRepeat = true;
        return evaluateValue(level, startValue, endValue, maxLevel, infiniteRepeat);
    }
    function flat_damage(level, player_level)   { 
        const levelUpgrades = [
            [70, 1],
            [73, 1],
            [81, 1],
            [92, 1],
            [101, 1],
            [109, 1],
            [118, 1],
            [127, 1],
            [134, 1],
            [137, 1],
            [143, 1]
        ]
        if (player_level < 70) return (50/49)*level - 50/49; 
        let flat = level;
        for (let [threshold, f] of levelUpgrades) {
            if (level >= threshold) {
                flat += f;
            } else {
                break;
            }
        }
        console.log(flat);
        console.log(level);
        return (50/49)*flat - 50/49; 
    }
    function damage_mult(level)   { 
        const levelUpgrades = [
            [4, 1.2],
            [10, 1.2],
            [21, 1.2],
            [32, 1.1],
            [40, 1.15],
            [45, 1.2],
            [49, 1.1],
            [54, 1.1],
            [63, 1.25],
            [66, 1.2],
            [77, 1.5],
            [85, 1.2],
            [91, 1.2],
            [98, 1.3],
            [105, 1.2],
            [113, 1.2],
            [123, 1.4],
            [129, 1.2]
        ];
        if (level < 4) return 1;
        let mult = 1;
        for (let [threshold, m] of levelUpgrades) {
            if (level >= threshold) {
                mult *= m;
            } else {
                break;
            }
        }
        return mult;    
    }
    // =====================HARD CODED /1.1 HERE CUZ I DONT KNOW WHERE THAT ACTUAL MULTIPLIER CAME FROM===================
    function damage(level,weapon_damage,weapon_added_mult,damage_level,flat_level,loot_percentage,loot_damage) {
        return ((weapon_damage + (flat_damage(flat_level)+loot_damage)*weapon_added_mult) * damage_mult(level) * (1 + damage_percent(damage_level) + loot_percentage) / 1.1);
    }
    function firerate_upgrade(level) { const x = Math.max(0, Math.min(400, level));
        return 0.75 * (1 - Math.pow((400 - x) / 400, 3)); }
    function firerate(weapon_firerate,firerate_level,loot_firerate,weapon_name) {
        const calculatedFirerate = (1/weapon_firerate)*(1-(firerate_upgrade(firerate_level)+loot_firerate));
        const minimumFirerate  = ['flamethrower', 'electromagnetism'].includes(weapon_name?.toLowerCase())?1/100:0.1;
        return {display:calculatedFirerate, capped:Math.max(calculatedFirerate,minimumFirerate)};
    }   
    function projectiles_per_shot(extra_projectile_level,loot_projectile) { return 1 + Math.ceil((extra_projectile_level-1)*1.5) + loot_projectile; }
    function total_damage_per_shot(level,weapon_damage,weapon_added_mult,damage_level,flat_level,loot_percentage,loot_damage,extra_projectile_level,loot_projectile) { return damage(level,weapon_damage,weapon_added_mult,damage_level,flat_level,loot_percentage,loot_damage)*projectiles_per_shot(extra_projectile_level,loot_projectile); }
    function damage_per_second(total_damage,firerate) { return total_damage/firerate; }
    function get_weapon_damage(weapon)      { return weapon?.stats?.Damage||0; }
    function get_weapon_added_mult(weapon)  { return weapon?.name?.toLowerCase()==='flamethrower'?0.1:weapon?.stats?.['Added Damage Mult']||1; }
    function get_loot_percentage(loots)   { return loots.reduce((sum,loot)=>sum+(loot?.stats?.['Projectile Damage']||0),0); }
    function get_loot_damage(loots)       { return loots.reduce((sum,loot)=>sum+(loot?.stats?.['Shot Damage']||0),0); }
    function get_loot_projectile(loots)   { return loots.reduce((sum,loot)=>sum+(loot?.stats?.['Projectile Shot']||0),0); }
    function get_weapon_fire_rate(weapon)  { return weapon?.stats?.['Fire Rate']||0; }
    function get_loot_fire_rate(loots)    { return loots.reduce((sum,loot)=>sum+(loot?.stats?.['Fire Rate']||0),0); }

    /* ---------- SLOT RENDERING ---------- */
    function renderSlot(slotIndex) {
        const slot = document.createElement('div');
        slot.className = 'loot-slot';
        slot.dataset.idx = slotIndex;

        if (lootSlots[slotIndex]) {
            const loot = lootSlots[slotIndex];
            slot.innerHTML = `
                <div class="inner">
                    <img src="${loot.icon}" alt="${loot.name}">
                    <button class="remove-btn" title="Remove">X</button>
                </div>`;
            slot.querySelector('.remove-btn').onclick = event => {
                event.stopPropagation();
                clearSlot(slotIndex);
            };
        } else {
            slot.innerHTML = `<div class="inner"><span class="plus">+</span></div>`;
        }

        slot.onclick = () => openPopup(slotIndex);
        return slot;
    }

    function clearSlot(slotIndex) {
        lootSlots[slotIndex] = null;
        saveSlots();
        lootGrid.children[slotIndex].replaceWith(renderSlot(slotIndex));
    }

    function setSlot(slotIndex, loot) {
        lootSlots[slotIndex] = loot;
        saveSlots();
        lootGrid.children[slotIndex].replaceWith(renderSlot(slotIndex));
    }

    function saveSlots() {
        localStorage.setItem('lootSlots', JSON.stringify(lootSlots.map(loot=>loot?.name||null)));
    }

    function openPopup(slotIndex) {
        lootPopup.style.display = 'flex';
        lootPopupContent.dataset.idx = slotIndex;
        const search = document.getElementById('loot-search');
        search.focus();
        search.select();
    }

    /* ---------- POPUP ---------- */
    lootPopup.onclick = event => { if (event.target===lootPopup) lootPopup.style.display='none'; };

    /* ---------- INITIALISATION ---------- */
    function initApp() {
        /* weapons */
        data.weapons.forEach(weapon => {
            const button = document.createElement('button');
            button.textContent = weapon.name;
            button.className = 'p-2 border rounded bg-gray-600 hover:bg-gray-500 text-gray-100 border-gray-500';
            button.onclick = () => {
                document.querySelectorAll('#weapons-container button')
                    .forEach(btn=>btn.className='p-2 border rounded bg-gray-600 hover:bg-gray-500 text-gray-100 border-gray-500');
                button.className='p-2 border rounded bg-blue-600 text-white border-blue-500';
                selectedWeapon = weapon;
                localStorage.setItem('selectedWeapon', weapon.name);
            };
            document.getElementById('weapons-container').appendChild(button);
        });

        /* 18 loot slots */
        for (let i=0;i<18;i++) lootGrid.appendChild(renderSlot(i));

        /* search input */
        const searchInput = document.getElementById('loot-search');

        /* loot cards */
        const rarityColor = {S:'text-yellow-300',A:'text-magenta-300',B:'text-blue-500',C:'text-green-600',D:'text-white-500',E:'text-gray-600'};
        Object.values(data.loot).flat().forEach(loot => {
            const rarity = Object.keys(data.loot).find(key=>data.loot[key].some(item=>item.name===loot.name));
            const card = document.createElement('div');
            card.className='loot-card bg-gray-800 p-2 rounded shadow-md flex flex-col items-center text-sm cursor-pointer hover:bg-gray-700';
            card.dataset.name = loot.name.toLowerCase();
            const stats = Object.entries(loot.stats || {})
                .map(([k,v]) => `${k}: ${v}`)
                .join('<br>') || 'No stats';

            card.innerHTML = `
                <img src="${loot.icon}" class="w-10 h-10 mb-1 object-contain">
                <span class="text-xs text-gray-100">${loot.name}</span>
                <span class="text-xs ${rarityColor[rarity]||'text-cyan-400'}">Rarity: ${rarity}</span>
                <div class="loot-tooltip">${stats}</div>`;
            card.onclick = () => {
                const slotIndex = +lootPopupContent.dataset.idx;
                setSlot(slotIndex, loot);
                lootPopup.style.display='none';
            };
            lootPopupContent.appendChild(card);
        });

        /* search functionality */
        searchInput.oninput = () => {
            const query = searchInput.value.toLowerCase();
            lootPopupContent.querySelectorAll('.loot-card').forEach(card => {
                if (!query) {
                    card.style.display = 'flex';
                } else {
                    const regex = new RegExp(query.split('').join('.*'));
                    card.style.display = regex.test(card.dataset.name) ? 'flex' : 'none';
                }
            });
        };

        /* load saved data */
        const savedWeapon = localStorage.getItem('selectedWeapon');
        if (savedWeapon) {
            const btn = Array.from(document.querySelectorAll('#weapons-container button'))
                .find(b => b.textContent === savedWeapon);
            btn?.click();
        }

        JSON.parse(localStorage.getItem('lootSlots')||'[]').forEach((name,i) => {
            if (name && i<18) {
                const loot = Object.values(data.loot).flat().find(item=>item.name===name);
                if (loot) setSlot(i,loot);
            }
        });

        ['level','damage_level','flat_level','extra_projectile_level','firerate_level'].forEach(id => {
            const savedValue = localStorage.getItem(id);
            if (savedValue!==null) document.getElementById(id).value = savedValue;
            document.getElementById(id).oninput = () => localStorage.setItem(id, document.getElementById(id).value);
        });
    }

    /* ---------- CALCULATE ---------- */
    let selectedWeapon = null;
    document.getElementById('calculate-btn').onclick = () => {
        if (!selectedWeapon) return alert('Select a weapon first');

        const selectedLoots = lootSlots.filter(Boolean);
        const level = +document.getElementById('level').value || 1;
        const damage_level = +document.getElementById('damage_level').value || 1;
        const flat_level = +document.getElementById('flat_level').value || 1;
        const extra_projectile_level = +document.getElementById('extra_projectile_level').value || 1;
        const firerate_level = +document.getElementById('firerate_level').value || 1;

        const weapon_damage = get_weapon_damage(selectedWeapon);
        const weapon_added_mult = get_weapon_added_mult(selectedWeapon);
        const loot_percentage = get_loot_percentage(selectedLoots);
        const loot_damage = get_loot_damage(selectedLoots);
        const loot_projectile = get_loot_projectile(selectedLoots);
        const weapon_firerate = get_weapon_fire_rate(selectedWeapon);
        const loot_firerate = get_loot_fire_rate(selectedLoots);

        const dmg = damage(level,weapon_damage,weapon_added_mult,damage_level,flat_level,loot_percentage,loot_damage);
        const proj = projectiles_per_shot(extra_projectile_level,loot_projectile);
        const fr = firerate(weapon_firerate,firerate_level,loot_firerate,selectedWeapon.name);
        const tot = total_damage_per_shot(level,weapon_damage,weapon_added_mult,damage_level,flat_level,loot_percentage,loot_damage,extra_projectile_level,loot_projectile);
        const dps = damage_per_second(tot,fr.capped);


        const details = document.getElementById('calc-details');
        details.innerHTML = `
            damage upgrade = ${damage_percent(damage_level)}<br>
            flat damage = ${flat_damage(flat_level)}<br>
            damage mult = ${damage_mult(level)}<br>
            fire rate upgrade = ${firerate_upgrade(firerate_level)}<br>
            loot projectile damage = ${loot_percentage}<br>
            loot shot damage = ${loot_damage}<br>
            loot projectile = ${loot_projectile}<br>
            loot fire rate = ${loot_firerate}
        `;

        document.getElementById('result-damage').textContent = dmg.toFixed(6);
        document.getElementById('result-projectiles').textContent = Math.floor(proj);
        document.getElementById('result-firerate').textContent =
            fr.display < (['flamethrower', 'electromagnetism'].includes(selectedWeapon.name.toLowerCase())?1/100:0.1)
            ? `${fr.display.toFixed(6)} (min firerate reached)`
            : fr.display.toFixed(6);
        document.getElementById('result-total-damage').textContent = tot.toFixed(6);
        document.getElementById('result-dps').textContent = dps.toFixed(6);
        document.getElementById('results').classList.remove('hidden');
    };

    loadData();
</script>
</body>
</html>